---
name: supply-chain

on:
  push:
    branches:
      - main
  pull_request:
  workflow_dispatch:

jobs:
  default:
    runs-on: ubuntu-latest
    steps:
      - name: Check out source code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      # Remove this after action is made public
      - uses: actions/checkout@v3
        with:
          repository: vmware-tanzu/build-image-action
          token: ${{ secrets.PRIVATE_REPO_ACCESS_TOKEN }}
          persist-credentials: false
          path: ./.github/actions/build-image-action

      # Remove this after action is made public
      - name: ghcr.io docker registry login
        run: |
          echo "${{ secrets.PRIVATE_REPO_ACCESS_TOKEN }}" | docker login ghcr.io -u "empty" --password-stdin
          docker pull ghcr.io/vmware-tanzu/build-image-action:main

      - uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Test
        run: mvn --no-transfer-progress test

      - name: Build Image
        id: build
        #uses: vmware-tanzu/build-image-action@v1
        uses: ./.github/actions/build-image-action
        with:
          # auth
          server: ${{ secrets.SERVER }}
          token: ${{ secrets.TOKEN }}
          ca_cert: ${{ secrets.CA_CERT }}
          namespace: ${{ secrets.NAMESPACE }}
          # image config
          destination: gcr.io/ship-interfaces-dev/github-actions-poc
          env: |
            BP_JAVA_VERSION=17

      - name: Validate Output
        run: |
          if [ "${{ steps.build.outputs.name }}" == "" ]; then
            echo "::error::No output from previous step"
            exit 1
          fi

      - name: Scan Image
        uses: anchore/scan-action@v3
        with:
          image: "${{ steps.build.outputs.name }}"
          fail-build: false
